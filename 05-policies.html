<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Multicluster Application Deployment with Advanced Cluster Management and GitOps</title>
    <link rel="canonical" href="https://xbryan1.github.io/rhte-2023-acm-docs/05-policies.html">
    <link rel="prev" href="04-application.html">
    <link rel="next" href="06-multiclusterapplication.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="./_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="./_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://xbryan1.github.io/rhte-2023-acm-docs">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#architecture">Hands-on Lab Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#occontext">Switching context between clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#sources">Hands-on Lab Git repository</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-deploy.html">2. Install Advanced Management and GitOps Operators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#install">Install RHACM Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#console">Access to the ACM Web Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#gitops">Install GitOps Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#gitopsacm">Integrate GitOps and ACM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#managedcluster">Registering local-cluster to GitOps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#deployall">Creating an ArgoCD Setup app-of-apps </a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-installcluster.html">3. Install a new Openshift Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#credentials">Setup credentials</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#install">Deploy new Openshift Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-application.html">4. Deploy a Multicluster Application with GitOps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-application.html#application">Deploy GitOps Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-application.html#applicationacm">Creating an Argo CD application from ACM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-application.html#applicationcli">Creating an Argo CD application from CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-application.html#applicationsync">Syncing an ArgoCD Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-policies.html">5. Setup Advanced Cluster Management Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#setup">Configure Policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-multiclusterapplication.html">6. Advanced Cluster Management Multicluster Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#06-policies.adoc#hibernate">Hibernate / Resume OCP Clusters across your domain</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a></li>
    <li><a href="05-policies.html">5. Setup Advanced Cluster Management Policies</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/xbryan1/rhte-2023-acm-docs/edit/master/documentation/modules/ROOT/pages/05-policies.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="policies"><a class="anchor" href="#policies"></a>Deploy Red Hat Advanced Management Policies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, you are going to create two policies. The policies can be used to check that the OpenShift clusters are compliant.</p>
</div>
<div class="paragraph">
<p>First, you are going to create a policy to check that a specific namespace exists on both clusters. As the namespace does not exsit and the policy is on Inform mode only, the policy is not going to be compliant. Later, you can create the namespace in one or two OpenShift clusters and check again the policy. The policy will be compliant on the cluster or clusters where the namespace will be created.</p>
</div>
<div class="paragraph">
<p>Finally, you are going to create another policy to check if the Compliance Operator is installed. This policy is going to be on Enforce mode, so it is going to remediate itself if the policy is not compliant. As the Compliance Operator is not installed by default, you are going to check that the policy is going to install the operator itself to be compliant.</p>
</div>
<div class="paragraph">
<p>To create the policies, you can use the Red Hat Advanced Cluster Management web interface, or you can use the command line interface (CLI).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="firstpolicygui"><a class="anchor" href="#firstpolicygui"></a>Setup the first policy via web interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To setup the first policy, you need to enter into the Red Hat Advanced Cluster Management route first. You can find it in the open-cluster-management namespace.</p>
</div>
<div class="paragraph">
<p>After entering into Red Hat Advanced Cluster Management web interface, you need to enter into the "Governance" section.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy01.png" alt="policy01">
</div>
</div>
<div class="paragraph">
<p>To create the policy, you should click into the "Create policy" button.</p>
</div>
<div class="paragraph">
<p>You need to choose a name and a namespace. You can use any name and you can use the "default" namespace.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy02.png" alt="policy02">
</div>
</div>
<div class="paragraph">
<p>The policy will be in "Inform" mode. You need to click into the "Add policy template" link.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy03.png" alt="policy03">
</div>
</div>
<div class="paragraph">
<p>You need to choose the "policy-namespace" policy.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy04.png" alt="policy04">
</div>
</div>
<div class="paragraph">
<p>Then, you need to describe the policy. So, we are going to check that the namespace named "rhte" should exist. So, write "rhte" into the name form in "Must have namespace" section. You can use "default" in "Include namespaces".</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy05.png" alt="policy05">
</div>
</div>
<div class="paragraph">
<p>After that, you can go to the next step, which is to create a New placement for the policy.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy06.png" alt="policy06">
</div>
</div>
<div class="paragraph">
<p>To create the new placement, you need to choose the labels.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy07.png" alt="policy07">
</div>
</div>
<div class="paragraph">
<p>In this case, we are going to use the vendor: OpenShift label.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy08.png" alt="policy08">
</div>
</div>
<div class="paragraph">
<p>Now, you can review the Policy annotations. You don&#8217;t need no modify any field of this form.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy09.png" alt="policy09">
</div>
</div>
<div class="paragraph">
<p>Finally, you can review your policy and create it.</p>
</div>
<div class="paragraph">
<p>After the policy is created, you can check if the policy is compliant or not. As the namespace does not exist, the policy should not be compliant. You can create the "rhte" project on one or two OpenShift clusters and check if the policy is now compliant.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="secondpolicygui"><a class="anchor" href="#secondpolicygui"></a>Setup the second policy via web interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, we are going to create the second policy. You need to choose the name and the namespace again. You can use any name and the "default" namespace.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy10.png" alt="policy10">
</div>
</div>
<div class="paragraph">
<p>In this case, you are going to select "Enforce" as a remediation. As this policy is going to remediate itself.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy11.png" alt="policy11">
</div>
</div>
<div class="paragraph">
<p>You need to click into "Add policy template" and use "Compliance Operator is installed". You need to choose "None" as a Prune Object Behaviour in all Configuration Policy objects.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy12.png" alt="policy12">
</div>
</div>
<div class="paragraph">
<p>You need to chose "Enforce" as a Remediation also.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy13.png" alt="policy13">
</div>
</div>
<div class="paragraph">
<p>As a placement, you are going to use the same placement as the previous rule: Choose vendor: OpenShift.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy14.png" alt="policy14">
</div>
</div>
<div class="paragraph">
<p>On Policy annotations, you can review the default values. You don&#8217;t need to change anything in this form.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy15.png" alt="policy15">
</div>
</div>
<div class="paragraph">
<p>Finally, you can review the policy.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/policies/policy16.png" alt="policy16">
</div>
</div>
<div class="paragraph">
<p>Once the policy is created, you can view that the policy is not compliant, and you can see that the Compliance Operator will be automatically installed. After the operator is installed, the policy will be compliant.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="firstpolicycli"><a class="anchor" href="#firstpolicycli"></a>Setup the first policy via CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can follow this example to create the first policy via CLI. You can create a namespace-policy.yaml file:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: namespace-policy
  namespace: default
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
    policy.open-cluster-management.io/standards: NIST SP 800-53
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: policy-namespace
        spec:
          namespaceSelector:
            exclude:
              - kube-*
            include:
              - default
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Namespace
                metadata:
                  name: rhte
          pruneObjectBehavior: None
          remediationAction: inform
          severity: low
  remediationAction: inform
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: namespace-policy-placement
  namespace: default
spec:
  clusterConditions: []
  clusterSelector:
    matchExpressions:
      - key: vendor
        operator: In
        values:
          - OpenShift
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: namespace-policy-placement
  namespace: default
placementRef:
  name: namespace-policy-placement
  apiGroup: apps.open-cluster-management.io
  kind: PlacementRule
subjects:
  - name: namespace-policy
    apiGroup: policy.open-cluster-management.io
    kind: Policy</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example, will create the Policy to check if the "rhte" namespace exists. Also, this example is going to create a PlacementRule to apply the policie on all clusters with "vendor: OpenShift" label. Finally, this example will create a binding between the policy and the PlacementRule.</p>
</div>
<div class="paragraph">
<p>Finally, you can create the policy with the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create -f namespace-policy.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the policy is created, you can check if the policy is compliant or not. As the namespace does not exist, the policy should not be compliant. You can create the "rhte" project on one or two OpenShift clusters and check if the policy is now compliant.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="secondpolicycli"><a class="anchor" href="#secondpolicycli"></a>Setup the second policy via CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To create the second policy via CLI, you can create a compliance-policy.yaml file with the following content:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: compliance-policy
  namespace: default
  annotations:
    policy.open-cluster-management.io/categories: CA Security Assessment and Authorization
    policy.open-cluster-management.io/controls: CA-2 Security Assessments, CA-7 Continuous Monitoring
    policy.open-cluster-management.io/standards: NIST SP 800-53
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: comp-operator-ns
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Namespace
                metadata:
                  name: openshift-compliance
          pruneObjectBehavior: None
          remediationAction: enforce
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: comp-operator-operator-group
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: operators.coreos.com/v1
                kind: OperatorGroup
                metadata:
                  name: compliance-operator
                  namespace: openshift-compliance
                spec:
                  targetNamespaces:
                    - openshift-compliance
          pruneObjectBehavior: None
          remediationAction: enforce
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: comp-operator-subscription
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: operators.coreos.com/v1alpha1
                kind: Subscription
                metadata:
                  name: compliance-operator
                  namespace: openshift-compliance
                spec:
                  name: compliance-operator
                  installPlanApproval: Automatic
                  source: redhat-operators
                  sourceNamespace: openshift-marketplace
          pruneObjectBehavior: None
          remediationAction: enforce
          severity: high
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: comp-operator-status
        spec:
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: operators.coreos.com/v1alpha1
                kind: ClusterServiceVersion
                metadata:
                  namespace: openshift-compliance
                spec:
                  displayName: Compliance Operator
                status:
                  phase: Succeeded
          pruneObjectBehavior: None
          remediationAction: enforce
          severity: high
  remediationAction: enforce
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: compliance-policy-placement
  namespace: default
spec:
  clusterConditions: []
  clusterSelector:
    matchExpressions:
      - key: vendor
        operator: In
        values:
          - OpenShift
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: compliance-policy-placement
  namespace: default
placementRef:
  name: compliance-policy-placement
  apiGroup: apps.open-cluster-management.io
  kind: PlacementRule
subjects:
  - name: compliance-policy
    apiGroup: policy.open-cluster-management.io
    kind: Policy</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create the policy, apply the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create -f compliance-policy.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the policy is created, you can view that the policy is not compliant, and you can see that the Compliance Operator will be automatically installed. After the operator is installed, the policy will be compliant.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-application.html">4. Deploy a Multicluster Application with GitOps</a></span>
  <span class="next"><a href="06-multiclusterapplication.html">6. Advanced Cluster Management Multicluster Application</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
