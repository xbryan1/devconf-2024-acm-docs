<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Install Advanced Management and GitOps Operators :: Multicluster Application Deployment with Advanced Cluster Management and GitOps</title>
    <link rel="canonical" href="https://xbryan1.github.io/rhte-2023-acm-docs/02-deploy.html">
    <link rel="prev" href="01-setup.html">
    <link rel="next" href="03-installcluster.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="./_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="./_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://xbryan1.github.io/rhte-2023-acm-docs">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#architecture">Hands-on Lab Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#sources">Git repositories</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-deploy.html">2. Install Advanced Management and GitOps Operators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#install">Install RHACM Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#console">Access to the ACM Web Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#gitops">Install GitOps Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#gitopsacm">Integrate GitOps and ACM</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-installcluster.html">3. Install a new Openshift Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#credentials">Setup credentials</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#install">Deploy new Openshift Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#04-deployapplication.adoc">4. Deploy a Multicluster Application with GitOps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#04-deployapplication.adoc#application">Deploy GitOps Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#05-policies.adoc">5. Setup Advanced Cluster Management Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#05-policies.adoc#setup">Configure Policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#06-multiclusterapplication.adoc">6. Advanced Cluster Management Multicluster Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#06-policies.adoc#hibernate">Hibernate / Resume OCP Clusters across your domain</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a></li>
    <li><a href="02-deploy.html">2. Install Advanced Management and GitOps Operators</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/xbryan1/rhte-2023-acm-docs/edit/master/documentation/modules/ROOT/pages/02-deploy.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Install Advanced Management and GitOps Operators</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section will guide you through the ACM and Argo CD installation and integration in order to deploy application both local and remote clusters from ACM.</p>
</div>
<div class="paragraph">
<p>Here’s a list of required operators to install through the Operator Lifecycle Manager (OLM), which manages the installation, upgrade, and removal:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ACM Operator</p>
<div class="literalblock">
<div class="content">
<pre>image::operators/acm.png[]</pre>
</div>
</div>
</li>
<li>
<p>GitOps Operator</p>
<div class="literalblock">
<div class="content">
<pre>image::operators/gitops.png[]</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The OpenShift Container Platform provided in this lab meets the minimal <a href="https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.6/html/install/installing#requirements-and-recommendations">requirements</a> from the official documentation. The cluster hub components will be installed on worker nodes, no <a href="https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.6/html/install/installing#installing-on-infra-node">infrastructure</a> nodes will be provided.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
OpenShift Container Platform required access: Cluster administrator (cluster-admin) permissions.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install"><a class="anchor" href="#install"></a>Install RHACM Operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Openshift cluster already installed <code>local-cluster</code> has not RHACM operator installed, so the first step is proceed with the ACM Operator installation.</p>
</div>
<div class="paragraph">
<p>Clone the sources repository and build yaml files with <code>oc kustomize</code> to prepare the installation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone repository</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone <a href="https://github.com/xbryan1/rhte-2023-acm-apps" class="bare">https://github.com/xbryan1/rhte-2023-acm-apps</a></code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd rhte2023

tree -L 3 00_boostrap/base/acm_operator/

00_boostrap/base/acm_operator/
└── base
    ├── acm_namespace.yaml
    ├── acm_operatorgroup.yaml
    ├── acm_subscription.yaml
    └── kustomization.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc kustomize 00_boostrap/base/acm_operator/base</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable master node scheduling</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This configuration is not recommended for production
</td>
</tr>
</table>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc replace -k 00_boostrap/base/openshift/base</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>install ACM Operator:</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k 00_boostrap/base/acm_operator/base</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc apply -k 00_boostrap/base/acm_operator/base

namespace/open-cluster-management created
operatorgroup.operators.coreos.com/open-cluster-management-rhte2023 created
subscription.operators.coreos.com/advanced-cluster-management created

$ oc get pod -n open-cluster-management
NAME                                                              READY   STATUS    RESTARTS   AGE
multicluster-observability-operator-55bc5794d5-klkxv              1/1     Running   0          112s
multicluster-operators-application-6bfc6668d8-58lj4               3/3     Running   0          111s
multicluster-operators-channel-7787f9bd44-2hgnx                   1/1     Running   0          111s
multicluster-operators-hub-subscription-867648d86d-czprh          1/1     Running   0          111s
multicluster-operators-standalone-subscription-5c7457cdb9-6r7g5   1/1     Running   0          111s
multicluster-operators-subscription-report-58cd59df84-bpllj       1/1     Running   0          111s
multiclusterhub-operator-6d79bd8c7d-x75zb                         1/1     Running   0          112s
submariner-addon-56785df46f-xg52l                                 1/1     Running   0          111s</code></pre>
</div>
</div>
<div class="paragraph">
<p>After installing the ACM Operator we also need to create the CRD object <code>MultiClusterHub</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create <code>MultiClusterHub</code>:</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k 00_boostrap/base/acm_multiclusterhub/base</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until the ACM Operatator is installed. It can take up to 10 minutes for the MultiClusterHub custom resource status to display as Running in the <code>status.phase</code> field after you run the command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get mch -o=jsonpath='{.items[0].status.phase}' -n open-cluster-management</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ oc get mch -n open-cluster-management
NAME              STATUS       AGE
multiclusterhub   Running      4m13s

$ oc get pod -n open-cluster-management
NAME                                                              READY   STATUS    RESTARTS        AGE
console-chart-b5c6c-console-v2-5f4778f855-6jzsh                   1/1     Running   0               4m17s
console-chart-b5c6c-console-v2-5f4778f855-sjqgm                   1/1     Running   0               4m17s
grc-ceb7b-policy-addon-controller-6688c876d7-brhlg                1/1     Running   0               4m16s
grc-ceb7b-policy-addon-controller-6688c876d7-kghnp                1/1     Running   0               4m16s
grc-ceb7b-policy-propagator-67bc7c8664-65fmg                      2/2     Running   0               4m16s
grc-ceb7b-policy-propagator-67bc7c8664-94lg8                      2/2     Running   0               4m16s
insights-client-6bfc7b9b4c-7shvm                                  1/1     Running   0               4m23s
insights-metrics-6b47574bdb-27fsh                                 2/2     Running   0               4m23s
klusterlet-addon-controller-v2-bf8569f79-pjw2n                    1/1     Running   0               4m17s
klusterlet-addon-controller-v2-bf8569f79-pxjgw                    1/1     Running   0               4m17s
management-ingress-04176-dff6664c6-7gndj                          2/2     Running   0               4m17s
management-ingress-04176-dff6664c6-sjjqr                          2/2     Running   0               4m17s
multicluster-observability-operator-55bc5794d5-klkxv              1/1     Running   0               89m
multicluster-operators-application-6bfc6668d8-58lj4               3/3     Running   2 (4m54s ago)   89m
multicluster-operators-channel-7787f9bd44-2hgnx                   1/1     Running   1 (5m3s ago)    89m
multicluster-operators-hub-subscription-867648d86d-czprh          1/1     Running   9 (5m8s ago)    89m
multicluster-operators-standalone-subscription-5c7457cdb9-6r7g5   1/1     Running   0               89m
multicluster-operators-subscription-report-58cd59df84-bpllj       1/1     Running   0               89m
multiclusterhub-operator-6d79bd8c7d-x75zb                         1/1     Running   0               89m
multiclusterhub-repo-76cd98b984-chrss                             1/1     Running   0               7m48s
search-operator-8679f457fd-95t9m                                  1/1     Running   0               4m16s
search-prod-bba19-search-aggregator-7c89cb446b-t4w8v              1/1     Running   0               4m16s
search-prod-bba19-search-api-5d458bcd44-khtxz                     1/1     Running   0               4m16s
search-prod-bba19-search-api-5d458bcd44-w7jcz                     1/1     Running   0               4m16s
search-prod-bba19-search-collector-665b79db76-xcrfv               1/1     Running   0               4m16s
search-redisgraph-0                                               1/1     Running   0               3m53s
submariner-addon-56785df46f-xg52l                                 1/1     Running   6 (15m ago)     89m
volsync-addon-controller-79091-deploy-65766b9b7c-xnw67            1/1     Running   0               4m17s</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the multiclusterhub is not in <code>Running</code> status after a while, check the operator logs or pods status as follows:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs multiclusterhub-operator-xxx-xxx -n open-cluster-management

oc get pod -n open-cluster-management</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="console"><a class="anchor" href="#console"></a>Access to the ACM Web Console</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After the ACM Operator is installed, it provides dashboard UI. We can access it through the OpenShift <code>Route</code>. List routes in the <code>open-cluster-management</code> namespace and get address of console  <a href="https://multicloud-console.apps.&lt;YOUR_DOMAIN&gt" class="bare">https://multicloud-console.apps.&lt;YOUR_DOMAIN&gt</a>;.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get routes -n open-cluster-management

NAME                 HOST/PORT                                          PATH   SERVICES             PORT    TERMINATION          WILDCARD
multicloud-console   multicloud-console.apps.jclaretm.nasatam.support          management-ingress   https   reencrypt/Redirect   None</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multicluster Hub has to be installed and the RHACM Console accesible to proceed with the next steps.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gitops"><a class="anchor" href="#gitops"></a>Install GitOps Operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the following command to install the GitOps Operator based on ArgoCD.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k 00_boostrap/base/gitops_operator/base/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k 00_boostrap/base/gitops_operator/base/

oc apply -k 00_boostrap/base/gitops_operator/base/
namespace/openshift-gitops created
subscription.operators.coreos.com/openshift-gitops-operator created</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gitopsacm"><a class="anchor" href="#gitopsacm"></a>Integrate GitOps and ACM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ACM introduces a new <code>gitopscluster</code> resource kind, which connects to a <code>placement</code> resource to determine which clusters to import into Argo CD. This integration allows you to expand your fleet, while having Argo CD automatically engage in working with your new clusters. This means if you leverage Argo CD <code>ApplicationSets</code>, your application payloads are automatically applied to your new clusters as they are registered by RHACM in your Argo CD instances.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run the following commands to perform the GitOps Operator integration with RHACM</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k 00_boostrap/base/gitops_acm/base/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc apply -k 00_boostrap/base/gitops_acm/base/
gitopscluster.apps.open-cluster-management.io/gitops-acm-importer created
managedclusterset.cluster.open-cluster-management.io/rhte2023-gitops-clusters created
managedclustersetbinding.cluster.open-cluster-management.io/rhte2023-gitops-clusters created
placement.cluster.open-cluster-management.io/gitops-clusters created
gitopsservice.pipelines.openshift.io/cluster created</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Check that ArgoCD console is accessible and pods are in <code>Running</code> status</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get route -n openshift-gitops
NAME                      HOST/PORT                                                                PATH   SERVICES                  PORT    TERMINATION            WILDCARD
kam                       kam-openshift-gitops.apps.jclaretm.nasatam.support                              kam                       8443    passthrough/None       None
openshift-gitops-server   openshift-gitops-server-openshift-gitops.apps.jclaretm.nasatam.support          openshift-gitops-server   https   passthrough/Redirect   None


$ oc get pod -n openshift-gitops
NAME                                                          READY   STATUS    RESTARTS   AGE
cluster-5547bb889c-z4xt5                                      1/1     Running   0          3m27s
kam-6f7bd59bff-kk7nk                                          1/1     Running   0          3m27s
openshift-gitops-application-controller-0                     1/1     Running   0          3m25s
openshift-gitops-applicationset-controller-6558f87b67-vh57v   1/1     Running   0          3m25s
openshift-gitops-dex-server-95795fd59-pxsbh                   1/1     Running   0          3m26s
openshift-gitops-redis-87698688c-ch9vn                        1/1     Running   0          3m26s
openshift-gitops-repo-server-84864f6446-2c979                 1/1     Running   0          3m26s
openshift-gitops-server-784dc4bc8-jgrnn                       1/1     Running   0          3m26s</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd/argocd_login.png" alt="argocd login">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Login into the ArgoCD Console with the Openshift credentials.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd/argocd_noapps.png" alt="argocd noapps">
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-setup.html">1. Environment Setup</a></span>
  <span class="next"><a href="03-installcluster.html">3. Install a new Openshift Cluster</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
