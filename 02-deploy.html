<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Install Advanced Management and GitOps Operators :: Multicluster Application Deployment with Advanced Cluster Management and GitOps</title>
    <link rel="canonical" href="https://xbryan1.github.io/rhte-2023-acm-docs/02-deploy.html">
    <link rel="prev" href="01-setup.html">
    <link rel="next" href="03-installcluster.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="./_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="./_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://xbryan1.github.io/rhte-2023-acm-docs">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#architecture">Hands-on Lab Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#sources">Hands-on Lab Git repository</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-deploy.html">2. Install Advanced Management and GitOps Operators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#install">Install RHACM Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#console">Access to the ACM Web Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#gitops">Install GitOps Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#gitopsacm">Integrate GitOps and ACM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#managedcluster">Registering local-cluster to GitOps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deployall">Creating an ArgoCD Setup app-of-apps </a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-installcluster.html">3. Install a new Openshift Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#credentials">Setup credentials</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#install">Deploy new Openshift Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-application.html">4. Deploy a Multicluster Application with GitOps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-application.html#application">Deploy GitOps Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-application.html#applicationacm">Creating an Argo CD application from ACM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-application.html#applicationcli">Creating an Argo CD application from CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-application.html#applicationsync">Syncing an ArgoCD Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-policies.html">5. Setup Advanced Cluster Management Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-policies.html#setup">Configure Policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-multiclusterapplication.html">6. Advanced Cluster Management Multicluster Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#06-policies.adoc#hibernate">Hibernate / Resume OCP Clusters across your domain</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a></li>
    <li><a href="02-deploy.html">2. Install Advanced Management and GitOps Operators</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/xbryan1/rhte-2023-acm-docs/edit/master/documentation/modules/ROOT/pages/02-deploy.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Install Advanced Management and GitOps Operators</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section will guide you through the ACM and GitOps CD Operators installation and the ACM/GitOps integration in order to deploy application both local and remote clusters.</p>
</div>
<div class="paragraph">
<p>Hereâ€™s a list of required operators to install through the Operator Lifecycle Manager (OLM), which manages the installation, upgrade, and removal:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ACM Operator</strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy01.png" alt="deploy01">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>GitOps Operator</strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy02.png" alt="deploy02">
</div>
</div>
</div>
</div>
<h1 id="_note" class="sect0"><a class="anchor" href="#_note"></a>NOTE:</h1>
<div class="ulist">
<ul>
<li>
<p>The OpenShift Container Platform provided in this lab meets the minimal <a href="https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.6/html/install/installing#requirements-and-recommendations">requirements</a> from the official documentation. The cluster hub components will be installed on worker nodes, no <a href="https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.6/html/install/installing#installing-on-infra-node">infrastructure</a> nodes will be provided.</p>
</li>
<li>
<p>OpenShift Container Platform required access: Cluster administrator (cluster-admin) permissions.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div id="install" class="paragraph">
<p>== Install ACM Operator</p>
</div>
<div class="paragraph">
<p>We will go through <code>Kustomize</code> templates to perform ACM Operator installation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Clone repository</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone <a href="https://github.com/xbryan1/rhte-2023-acm-apps" class="bare">https://github.com/xbryan1/rhte-2023-acm-apps</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>Directories structure</p>
</div>
<div class="imageblock right">
<div class="content">
<img src="_images/deploy/deploy03.png" alt="deploy03">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Declarative approach with Kustomize</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>YAML files uses Kustomize templates, just to take a look how it works, run the following command. This example does not apply any configuration.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd rhte-2023-acm-apps/rhte2023/; oc kustomize 02_bootstrap/base/acm_operator/base</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy04.png" alt="deploy04">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Enable master node scheduling</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Enabling master node scheduling will be able to deploy workloads on master nodes.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc replace -k 02_bootstrap/base/openshift/base</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy05.png" alt="deploy05">
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This configuration is not recommended for production.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Install ACM Operator</strong>:</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k 02_bootstrap/base/acm_operator/base</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch oc get pod -n open-cluster-management</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy06.png" alt="deploy06">
</div>
</div>
<div class="paragraph">
<p>After installing the ACM Operator we also need to create the CRD object <code>MultiClusterHub</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create <code>MultiClusterHub</code>:</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k 02_bootstrap/base/acm_multiclusterhub/base</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy07.png" alt="deploy07">
</div>
</div>
<div class="paragraph">
<p>Wait until the ACM Operatator is installed. It can take up to 10 minutes for the MultiClusterHub custom resource status to display as Running in the <code>status.phase</code> field after you run the command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc get mch -o=jsonpath='{.items[0].status.phase}' -n open-cluster-management</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy08.png" alt="deploy08">
</div>
</div>
<div class="paragraph">
<p>If the multiclusterhub is not in <code>Running</code> status after a while, check the operator logs or pods status as follows:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs multiclusterhub-operator-xxx-xxx -n open-cluster-management</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch oc get pod -n open-cluster-management</code></pre>
</div>
</div>
<div id="console" class="paragraph">
<p>== Access to the ACM Web Console</p>
</div>
<div class="paragraph">
<p>After the ACM Operator is installed, it provides a dashboard UI. We can access it through a OpenShift <code>Route</code>. List routes in the <code>open-cluster-management</code> namespace and get address of console  <a href="https://multicloud-console.apps.&lt;YOUR_DOMAIN&gt" class="bare">https://multicloud-console.apps.&lt;YOUR_DOMAIN&gt</a>;.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n open-cluster-management</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy09.png" alt="deploy09">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Multicluster Hub has to be installed and the RHACM Console accesible to proceed with the next steps.
</td>
</tr>
</table>
</div>
<div id="gitops" class="paragraph">
<p>== Install GitOps Operator</p>
</div>
<div class="paragraph">
<p>Run the following command to install the GitOps Operator based on ArgoCD.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k 02_bootstrap/base/gitops_operator/base/</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy10.png" alt="deploy10">
</div>
</div>
<div class="paragraph">
<p>Check that ArgoCD console is accessible and pods are in <code>Running</code> status</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n openshift-gitops</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch oc get pods -n openshift-gitops</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy12.png" alt="deploy12">
</div>
</div>
<div class="paragraph">
<p>or from the Openshift Console</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy13.png" alt="deploy13">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy14.png" alt="deploy14">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Login into the ArgoCD Console with the Openshift credentials.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy15.png" alt="deploy15">
</div>
</div>
<div id="gitopsacm" class="paragraph">
<p>== Integrate GitOps and ACM</p>
</div>
<div class="paragraph">
<p>ACM introduces a new <code>gitopscluster</code> resource kind, which connects to a <code>placement</code> resource to determine which clusters to import into Argo CD. This integration allows you to expand your fleet, while having Argo CD automatically engage in working with your new clusters. This means if you leverage Argo CD <code>ApplicationSets</code>, your application payloads are automatically applied to your new clusters as they are registered by RHACM in your Argo CD instances.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy18.png" alt="deploy18">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Run the following commands to perform the GitOps Operator integration with RHACM</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k 02_bootstrap/base/gitops_acm/base/</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy11.png" alt="deploy11">
</div>
</div>
<div id="managedcluster" class="paragraph">
<p>== Registering local-cluster to GitOps</p>
</div>
<div class="paragraph">
<p>After the ACM/GitOps integration is done, you will label <code>local-cluster</code> (ACM) with <code>ClusterSet rhte2023-gitops-clusters</code> and environment <code>development</code>. This configuration will let us deploy applications into this Openshift cluster.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc label ManagedCluster local-cluster cluster.open-cluster-management.io/clusterset=rhte2023-gitops-clusters --overwrite</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc label ManagedCluster local-cluster gitops-cluster=true environment=production</code></pre>
</div>
</div>
<div class="paragraph">
<p>and check that cluster <code>local-cluster</code> is added as an ArgoCD Cluster from the <strong>ArgoCD Console &gt; Settings &gt; Clusters</strong> where we expect to see <code>local-cluster</code> as one of the clusters</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy16.png" alt="deploy16">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy17.png" alt="deploy17">
</div>
</div>
<div class="paragraph">
<p>and the <code>local-cluster</code> belongs to <code>ClusterSet rhte2023-gitops-clusters</code> through <code>Openshift Console &gt; Advanced Cluster Management &gt; Clusters &gt; Cluster sets</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy19.png" alt="deploy19">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/deploy/deploy20.png" alt="deploy20">
</div>
</div>
<div id="deployall" class="paragraph">
<p>== Creating an ArgoCD Setup app-of-apps</p>
</div>
<div class="paragraph">
<p>One option to setup an app-of-apps in Argo CD for the bootstrap instead of going step by step as we have seen :-)</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd rhte2023/02_bootstrap/argocd; oc create -f rhte2023-bootstrap-gitops.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>or from argocd cli</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">argocd app create rhte2023-bootstrap-gitops --project default --repo <a href="https://github.com/xbryan1/rhte-2023-acm-apps.git" class="bare">https://github.com/xbryan1/rhte-2023-acm-apps.git</a> --path rhte2023/02_bootstrap/base --dest-namespace openshift-gitops --dest-server <a href="https://api.jclaretm.nasatam.support:6443" class="bare">https://api.jclaretm.nasatam.support:6443</a></code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-setup.html">1. Environment Setup</a></span>
  <span class="next"><a href="03-installcluster.html">3. Install a new Openshift Cluster</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
