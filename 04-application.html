<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy a Multicluster Application with GitOps :: Multicluster Application Deployment with Advanced Cluster Management and GitOps</title>
    <link rel="canonical" href="https://xbryan1.github.io/devconf-2024-acm-docs/04-application.html">
    <link rel="prev" href="03-installcluster.html">
    <link rel="next" href="05-policies.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="./_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="./_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://xbryan1.github.io/devconf-2024-acm-docs">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#architecture">Hands-on Lab Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#occontext">Switching context between clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#sources">Hands-on Lab Git repository</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-deploy.html">2. Install Advanced Management and GitOps Operators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#install">Install RHACM Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#console">Access to the ACM Web Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#gitops">Install GitOps Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#gitopsacm">Integrate GitOps and ACM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#managedcluster">Registering local-cluster to GitOps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-deploy.html#deployall">App Of Everything</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-installcluster.html">3. Install a new Openshift Cluster</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#credentials">Setup credentials</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#credscli">Setup credentials via CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#install">Deploy new Openshift Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#installgui">Deploy a new OpenShift cluster via web interface</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#installcli">Deploy a new OpenShift cluster via CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#occontextnew">Switching context for the new cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-installcluster.html#registertnew">Registering rhte2023-cluster01 to GitOps</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-application.html">4. Deploy a Multicluster Application with GitOps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#applicationacm01">Application 1 - Deploying a ChatBot application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#applicationreplicas">Application 1 - Change number of replicas</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#applicationacm02">Application 2 - Deploying a ChatDraw application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#applicationimages">Application 2 - Change container image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#applicationacm03">Application - Deploying multiple Applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#applicationsync">Application - Sync and Diff</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-policies.html">5. Setup Advanced Cluster Management Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-policies.html#firstpolicygui">Setup the first policy via web</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-policies.html#secondpolicygui">Setup the second policy via web</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-policies.html#firstpolicycli">Setup the first policy via CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-policies.html#secondpolicycli">Setup the second policy via CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-policies.html#firstpolicygitops">Setup the first policy using GitOps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-policies.html#secondpolicygitops">Setup the first policy using GitOps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-multiclusterapplication.html">6. Advanced Cluster Management Multicluster Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#06-policies.adoc#hibernategui">Hibernate clusters via web</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#06-policies.adoc#hibernatecli">Hibernate clusters via CLI</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Multicluster Application Deployment with Advanced Cluster Management and GitOps</a></li>
    <li><a href="04-application.html">4. Deploy a Multicluster Application with GitOps</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/xbryan1/devconf-2024-acm-docs/edit/master/documentation/modules/ROOT/pages/04-application.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Deploy a Multicluster Application with GitOps</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><code>OpenShift GitOps</code> implements <code>Argo CD</code> as a controller so that it continuously monitors application definitions and configurations defined in a Git repository. Then, <code>Argo CD</code> compares the specified state of these configurations with their live state on the cluster.</p>
</div>
<div class="paragraph">
<p>The <code>ApplicationSet</code> leverages the cluster decision generator to interface Kubernetes custom resources that use custom resource-specific logic to decide which managed clusters to deploy to. A cluster decision resource generates a list of managed clusters, which are then rendered into the template fields of the ApplicationSet resource. This is done using duck-typing, which does not require knowledge of the full shape of the referenced Kubernetes resource.</p>
</div>
<div class="paragraph">
<p><code>ApplicationSet</code> is a sub-project of <code>Argo CD</code> that adds multicluster support. You will go through this section to create ApplicationSets from the Red Hat Advanced Cluster Management and from the ArgoCD CLI.</p>
</div>
<div class="paragraph">
<p>We are gonna deploy 4 applications to understand the how it works.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applicationacm01"><a class="anchor" href="#applicationacm01"></a>Application 1 - Deploying a ChatBot application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first Application will be created from the Advanced Cluster Management console and it will be placed on those Clusters matching labels:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Vendor=Openshift</strong></p>
</li>
<li>
<p><strong>Platform=AWS</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Go throught the Advanced Cluster Management Console and login with Openshift user:</p>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; Argo CD ApplicationSet - Push model</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application02.png" alt="application02">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; Argo CD ApplicationSet - Push model&gt; General</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ApplicationSet name</strong>: devconf2024-application-01</p>
</li>
<li>
<p><strong>Argo server</strong>: openshift-gitops</p>
</li>
<li>
<p><strong>Requeue time</strong>: 180</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application03.png" alt="application03">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; Argo CD ApplicationSet - Push model &gt; Template</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>URL</strong>: <a href="https://github.com/&lt;your_github_account&gt;/devconf-2024-acm-apps.git" class="bare">https://github.com/&lt;your_github_account&gt;/devconf-2024-acm-apps.git</a></p>
</li>
<li>
<p><strong>Revision</strong>: main</p>
</li>
<li>
<p><strong>Path</strong>: devconf2024/04_deploy_applications/devconf2024-application-01</p>
</li>
<li>
<p><strong>Remote Namespace</strong>: devconf2024-application-01</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application04.png" alt="application04">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; ApplicationSet &gt; Sync policy</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Automatically sync when cluster state changes</strong> (syncPolicy/automated/selfHeal=true)</p>
</li>
<li>
<p><strong>Delete resources that are no longer defined in the source repository</strong> (syncPolicy/automated/prune=true)</p>
</li>
<li>
<p><strong>Delete resources that are no longer defined in the source repository at the end of a sync operation</strong> (syncOptions/CreateNamespace=true)</p>
</li>
<li>
<p><strong>Automatically create namespace if it does not exist</strong> (syncOptions/CreateNamespace=true)</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application05.png" alt="application05">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; ApplicationSet &gt; Placement</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Placement</strong>: devconf2024-gitops-clusters</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application06.png" alt="application06">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; ApplicationSet &gt; Review and Submit</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application07.png" alt="application07">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; devconf2024-application-01 (filter by ApplicationSet) &gt; Topology</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application08.png" alt="application08">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Advanced Configuration &gt; Placements</strong></p>
</div>
<div class="paragraph">
<p>Check the number of cluster matching with <strong>Placement &gt; devconf2024-gitops-clusters</strong>, so we are expecting see the Application <strong>devconf2024-application-01</strong> deployed in all of them.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application08b.png" alt="application08b">
</div>
</div>
<div class="paragraph">
<p>Also, let&#8217;s check from the ArgoCD Console what is the Application status and from <code>oc</code> client</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Argo CD Console &gt; Applications</strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application09.png" alt="application09">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Application deployment pods on both clusters</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm get pod -n devconf2024-application-01</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context cluster01 get pod -n devconf2024-application-01</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s see how the Applications looks like checking the <code>Route</code> and copying on your browser.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm get route -n devconf2024-application-01</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>URL</strong>: <a href="https://devconf2024-application-01-devconf2024-application-01.&lt;your_domain_cluster&gt" class="bare">https://devconf2024-application-01-devconf2024-application-01.&lt;your_domain_cluster&gt</a>;</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context cluster01 get route -n devconf2024-application-01</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>URL</strong>: <a href="https://devconf2024-application-01-devconf2024-application-01.&lt;your_domain_cluster&gt" class="bare">https://devconf2024-application-01-devconf2024-application-01.&lt;your_domain_cluster&gt</a>;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application09b.png" alt="application09b">
</div>
</div>
<div class="paragraph">
<p>This is a GPT3 Chatbot, so just make questions on the chat to get bot&#8217;s answers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applicationreplicas"><a class="anchor" href="#applicationreplicas"></a>Application 1 - Change number of replicas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to check how ArgoCD and ACM are monitoring the Application, let&#8217;s make changes and see what happens.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Change application replicas</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s change the number of replicas in both clusters and check how it is fixed automatically.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm scale deployment/devconf2024-application-01 -n devconf2024-application-01 --replicas=0
oc --context cluster01 scale deployment/devconf2024-application-01 -n devconf2024-application-01 --replicas=0</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm get pod -n devconf2024-application-01
oc --context cluster01 get pod -n devconf2024-application-01</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a while, application will scale automatically to the initial number of replicas (5).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application09c.png" alt="application09c">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Make a change on the deployment yaml file</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now, let&#8217;s make a persistent change on the Git repository:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd 04_deploy_applications/rhte2023-application-01/base
sed -i 's/replicas: 5/replicas: 3/g' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "decreasing number of replicas"
git push origin main</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
See how configure a token GitHub <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token">Creating a personal access token</a> to push changes on your git repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the change has been pushed, sync the application again from ArgoCD Console and checking the ACM Topology</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In case you&#8217;ve got this error <a href="https://access.redhat.com/solutions/6975821">Unable to deploy revision: permission denied: applications, sync</a>, please fix as follows:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm adm groups new cluster-admins
oc --context acm adm groups add-users cluster-admins opentlc-mgr
oc --context acm adm policy add-cluster-role-to-group cluster-admin cluster-admins</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application09d.png" alt="application09d">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application15.png" alt="application15">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applicationacm02"><a class="anchor" href="#applicationacm02"></a>Application 2 - Deploying a ChatDraw application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The second Application will be created from the Advanced Cluster Management console and it will be deployed on those Clusters matching label:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>environment=development</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before create the application, let&#8217;s label the cluster <code>devconf2024-cluster01</code> with the label <strong>environment=development</strong>.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm label ManagedCluster devconf2024-cluster01 environment=development --overwrite</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create the Application from Advanced Cluster Management:</p>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; ApplicationSet</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application02.png" alt="application02">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; ApplicationSet &gt; General</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ApplicationSet name</strong>: devconf2024-application-02</p>
</li>
<li>
<p><strong>Argo server</strong>: openshift-gitops</p>
</li>
<li>
<p><strong>Requeue time</strong>: 180</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application10.png" alt="application10">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; ApplicationSet &gt; Template</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>URL</strong>: <a href="https://github.com/&lt;your_github_account&gt;/devconf-2024-acm-apps.git" class="bare">https://github.com/&lt;your_github_account&gt;/devconf-2024-acm-apps.git</a></p>
</li>
<li>
<p><strong>Revision</strong>: main</p>
</li>
<li>
<p><strong>Path</strong>: devconf2024/04_deploy_applications/devconf024-application-02</p>
</li>
<li>
<p><strong>Remote Namespace</strong>: devconf2024-application-02</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application11.png" alt="application11">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; ApplicationSet &gt; Sync policy</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Automatically sync when cluster state changes</strong> (syncPolicy/automated/selfHeal=true)</p>
</li>
<li>
<p><strong>Delete resources that are no longer defined in the source repository</strong> (syncPolicy/automated/prune=true)</p>
</li>
<li>
<p><strong>Delete resources that are no longer defined in the source repository at the end of a sync operation</strong> (syncOptions/CreateNamespace=true)</p>
</li>
<li>
<p><strong>Automatically create namespace if it does not exist</strong> (syncOptions/CreateNamespace=true)</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application12.png" alt="application12">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; ApplicationSet &gt; Placement</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Placement</strong>: devconf2024-gitops-clusters-environment</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application13.png" alt="application13">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Create Application &gt; ApplicationSet &gt; Review and Submit</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application14.png" alt="application14">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; devconf2024-application-02 (filter by ApplicationSet) &gt; Topology</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application15.png" alt="application15">
</div>
</div>
<div class="paragraph">
<p><strong>Advanced Cluster Management Console &gt; Applications &gt; Advanced Configuration &gt; Placements</strong></p>
</div>
<div class="paragraph">
<p>Check the number of cluster matching with <strong>Placement &gt; rhte2023-gitops-clusters-environment</strong>, so we are expecting see the Application <strong>rhte2023-application-02</strong> deployed in <strong>rhte2023-cluster01</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application16.png" alt="application16">
</div>
</div>
<div class="paragraph">
<p>Also, let&#8217;s check from the ArgoCD Console what is the Application status and from <code>oc</code> client</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Argo CD Console &gt; Applications</strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application17.png" alt="application17">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Application deployment pods</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context cluster01 get pod -n rhte2023-application-02</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s see how the Applications looks like checking the <code>Route</code> and copying on your browser.</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context cluster01 get route -n rhte2023-application-02</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>URL</strong>: <a href="https://rhte2023-application-02-rhte2023-application-02.&lt;your_domain&gt" class="bare">https://rhte2023-application-02-rhte2023-application-02.&lt;your_domain&gt</a>;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application18.png" alt="application18">
</div>
</div>
<div class="paragraph">
<p>This is a GPT3 Chatdraw, so just give a description about what you want to see.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applicationimages"><a class="anchor" href="#applicationimages"></a>Application 2 - Change container image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the <strong>rhte2023-application-02</strong> is already deployed, let&#8217;s change the application image:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Change application image commit and push your changes</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ../../../04_deploy_applications/rhte2023-application-02/base
sed -i 's/chatdraw:latest/chatdraw:rhte2023/g' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "changing the application image"
git push origin main</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the change has been pushed, sync the application again and verify that the application has been changed (background red color)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application19.png" alt="application19">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applicationacm03"><a class="anchor" href="#applicationacm03"></a>Application - Deploying multiple Applications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The third and fourth Applications will be created from the ArgoCD command line grouping both Applications <strong>rhte2023-application-03</strong> (RedHat Offices Photos) and <strong>rhte2023-application-04</strong> (Tetris) and deploying at the same time:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Application <strong>rhte2023-application-03</strong> will match <strong>Location=eu-west-2</strong> and <strong>area=fringe</strong> labels</p>
</li>
<li>
<p>Application <strong>rhte2023-application-04</strong> will match clusters with the largest allocatable <strong>CPU and memory</strong> allocatable CPU and memory.</p>
</li>
<li>
<p><strong>Apply new label to local-cluster</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm label ManagedCluster local-cluster area=fringe --overwrite</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Change ApplicationSet according to your settings:</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Change <strong>repoURL</strong> variable with your git repository <strong><a href="https://github.com/&lt;your_github_account&gt;/rhte-2023-acm-apps.git" class="bare">https://github.com/&lt;your_github_account&gt;/rhte-2023-acm-apps.git</a></strong></p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ../../..
vi 04_deploy_applications/argocd/rhte2023-application-03.yaml
vi 04_deploy_applications/argocd/rhte2023-application-04.yaml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Change Location according to your settings:</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">vi 04_deploy_applications/argocd/placement_location.yaml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Commit and push changes:</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git status
git add *
git commit -m "changing repository"
git push origin main</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Get ArgoCD password</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm get secret/openshift-gitops-cluster -n openshift-gitops -o jsonpath='{.data.admin\.password}' | base64 -d</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Get ArgoCD Route</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm get route -n openshift-gitops</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Login into ArgoCD</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">argocd login openshift-gitops-server-openshift-gitops.apps.&lt;your_domain&gt; --username admin --password &lt;your_password&gt; --insecure</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>List ArgoCD Clusters</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">argocd cluster list</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Create an ArgoCD Application</strong>:</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">argocd app create rhte2023-application-gitops \
--project default \
--repo &lt;your_forked_repository&gt; \
--path rhte2023/04_deploy_applications/argocd \
--sync-policy automated \
--dest-namespace openshift-gitops \
--dest-server <a href="https://api.&lt;your_domain&gt;:6443" class="bare">https://api.&lt;your_domain&gt;:6443</a></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Get ArgoCD Application details</strong>:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to check the deployment status run:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">argocd app list</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">argocd app get rhte2023-application-gitops</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Check Application pods</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to see where the Applications have been placed, go to <strong>Advanced Cluster Management &gt; Applications &gt; Advanced Configuration &gt; Placements</strong>, and check the number of the clusters matching <strong>Placements</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Application <strong>rhte2023-application-03</strong> &gt; rhte2023-gitops-clusters-location</p>
</li>
<li>
<p>Application <strong>rhte2023-application-04</strong> &gt; rhte2023-gitops-clusters-cpu</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Or going to <strong>Advanced Cluster Management &gt; Applications</strong> and filter per Application name and click on the Topology where you can see the Application deployed and the information about the targeted clusters.</p>
</div>
<div class="paragraph">
<p>Once you know where Applications are deployed, just check the Application pods status changing the context according to your environment:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm get pod -n rhte2023-application-03</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context cluster01 get pod -n rhte2023-application-04</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Applications routes</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s see how the Applications looks like checking the <code>Route</code> and copying on your browser. In this example, <strong>rhte2023-application-03</strong> is placed on <strong>local-cluster</strong> and <strong>rhte2023-application-04</strong> is placed in <code>rhte2023-cluster01</code>:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context acm get route -n rhte2023-application-03</code></pre>
</div>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --context cluster01 get route -n rhte2023-application-04</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Application <strong>rhte2023-application-03</strong> &gt; Red Hat Offices</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>URL</strong>: <a href="https://rhte2023-application-03-rhte2023-application-03.&lt;your_domain&gt" class="bare">https://rhte2023-application-03-rhte2023-application-03.&lt;your_domain&gt</a>;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application20.png" alt="application20">
</div>
</div>
<div class="paragraph">
<p><strong>URL</strong>: <a href="https://rhte2023-application-04-rhte2023-application-04.&lt;your_domain&gt" class="bare">https://rhte2023-application-04-rhte2023-application-04.&lt;your_domain&gt</a>;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Application <strong>rhte2023-application-04</strong> &gt; Tetris Game</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/application/application21.png" alt="application21">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applicationsync"><a class="anchor" href="#applicationsync"></a>Fix Application 03 - Sync and Diff</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s see a common issue with Application deployments and autoscalers and how to fix it. The third Application <strong>rhte2023-application-03</strong> is deployed with an <strong>HPA - horizontal pod autoscaler</strong> that let you specify the minimum and maximum number of pods you want to run. It means that this application will change the number of replicas and it will not match what is defined in Git repository, so the application will be <strong>out of sync</strong>. Let&#8217;s see how can fix this kind of issues:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Check and Sync the Application rhte2023-application-03-&lt;cluster&gt; from the ArgoCD UI</strong>. The Application status will be flapping between synced and of of sync status.</p>
</li>
<li>
<p><strong>Make changes on replicas definition</strong>:</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd 04_deploy_applications/rhte2023-application-03/base
sed -i '/replicas:/d' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "removing the replicas definition"
git push origin main</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commit, push your changes, sync the Application again.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This issue could also be solved adding <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/diffing/#application-level-configuration">ignoreDifferences</a> into the deployment definition.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applicationcpu"><a class="anchor" href="#applicationcpu"></a>Fix Application 04 - allocatable CPU and Memory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the last exercice from this section. The fourth application <strong>rhte2023-application-04</strong> will be deployed on that cluster with the largest allocatable CPU and Memory. Verify that in your environment is deployed on <code>rhte2023-cluster01</code>, if not change the score weight as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Change the score weight</strong>:</p>
</li>
</ul>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ../../../04_deploy_applications/argocd/
sed -i 's/weight: 10/weight: -9/g' placement_cpu.yaml
git add *
git commit -m "changing score weight"
git push origin main</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commit, push your changes, sync the Application again.</p>
</div>
<div class="paragraph">
<p>Great! You&#8217;ve completed the 4 Applications deployment! Congratulations!</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-installcluster.html">3. Install a new Openshift Cluster</a></span>
  <span class="next"><a href="05-policies.html">5. Setup Advanced Cluster Management Policies</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="./_/js/vendor/clipboard.js"></script>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
  </body>
</html>
